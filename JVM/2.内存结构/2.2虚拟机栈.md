# 2. 虚拟机栈

## 2.1 定义

虚拟机栈为每个线程分配的内存区域，由多个栈帧组成。每个栈帧对应一次方法调用时所需的内存。

**特点：**

- 栈大小可调整，超出限制会抛出 `StackOverflowError`。
- 栈空间可以动态扩展，但无法收缩。

## 2.2 内存结构

- 虚拟机栈包含多个栈帧，每个栈帧保存当前方法的局部变量表、操作数栈、动态链接、方法出口等信息。

## 2.3 线程切换

- 每个线程有独立的虚拟机栈，确保数据隔离，线程切换时能够正确恢复执行位置。

## 2.4 异常情况

- 可能会发生 `StackOverflowError`，栈空间不足时抛出。
- 由于栈是线程私有的，不会导致线程安全问题。

## 2.5 问题辨析

- **垃圾回收**：虚拟机栈内存不涉及垃圾回收，方法调用结束后栈帧被弹出。
- **栈内存分配**：栈内存过大会支持更多递归调用，但减少可执行线程数。
- **局部变量线程安全性**：局部变量在线程栈内是线程安全的，但如果其作用域超出栈（如被引用到堆），需要考虑线程安全问题。

## 2.6 栈内存溢出

- 栈溢出的原因可能是栈帧过大或栈的深度过深。可以通过调整 `-Xss256k` 参数来设置栈的大小。

## 2.7 线程运行诊断

- **诊断工具**：
  - 使用 `top` 查看 CPU 占用情况。
  - 使用 `ps` 查看哪个线程占用 CPU。
  - 使用 `jstack` 查看线程信息，定位具体线程。