# 四种分布式事务模式

## 1. XA 模式
### 1.1 概念

**XA（eXtended Architecture）** 是一种分布式事务协议，通常用于支持跨多个资源管理器（如数据库、消息队列等）的事务。

- **特点**: 
  - 使用两阶段提交协议（2PC）来保证事务的一致性。
  - 保证所有参与的资源管理器在同一个事务中要么都成功提交，要么都回滚。
  - 对于涉及多个资源管理器的事务，XA 协议能够提供强一致性。

> XA模式下RM由数据库提供

### 1.2 两阶段提交

#### **第一阶段：准备阶段（Prepare Phase）**

1. **事务发起者（TM）**
   - 启动全局事务。
   - 向**事务协调者（TC）**注册全局事务，并获得全局事务ID（XID）。
   - 调用本地资源管理器（RM）执行本地事务。

2. **资源管理器（RM）**
   - 执行本地事务的操作（如数据库操作）。
   - 在**事务协调者（TC）**发出准备请求时，执行本地事务的预处理，并确保没有问题可以提交。
   - 返回准备状态：如果本地事务准备好，可以提交，RM会返回"准备好"（prepared）状态；如果出现问题，RM会返回"回滚"（rollback）状态。

3. **事务协调者（TC）**
   - 收到**事务发起者（TM）**的准备请求后，协调所有参与的RM。
   - 向所有RM发送准备请求，并等待它们的响应（准备好或回滚）。
   - 根据所有RM的响应，判断是否继续进入提交阶段。

#### **第二阶段：提交/回滚阶段（Commit/Rollback Phase）**

1. **事务发起者（TM）**
   - 根据第一阶段**事务协调者（TC）**的协调结果：
     - 如果所有RM返回“准备好”，TM向TC请求提交全局事务。
     - 如果任何RM返回“回滚”，TM向TC请求回滚全局事务。
   
2. **资源管理器（RM）**
   - 根据**事务协调者（TC）**的指令：
     - 如果TC发送提交请求，RM执行本地事务提交。
     - 如果TC发送回滚请求，RM执行本地事务回滚。

3. **事务协调者（TC）**
   - 根据所有RM的准备状态决定是否提交或回滚全局事务：
     - 如果所有RM都返回“准备好”，TC向所有RM发送提交请求，完成全局事务提交。
     - 如果有任何RM返回“回滚”，TC向所有RM发送回滚请求，完成全局事务回滚。

#### 总结：

<Badge text="important" type="important" /> 

- **第一阶段（准备阶段）**：TM启动全局事务并请求RM执行本地事务；RM进行本地操作并报告准备状态；TC协调所有RM并判断是否进入提交阶段。
- **第二阶段（提交/回滚阶段）**：TM根据TC的判断请求提交或回滚全局事务；RM根据TC的指令执行本地事务提交或回滚；TC最终决定全局事务是否提交或回滚。

### 1.3**缺点**:

- `需要锁定数据库资源，等待二阶段结束后才会释放(资源锁定周期过长)`。性能开销较大，尤其是在高并发场景下。
- 复杂度高，易出现长时间锁定和死锁问题。
- XA模式是建立在数据库的事务管理功能之上的，没有事务管理功能的数据库无法使用XA模式。

## 2. AT 模式 

### 2.1 概念

**AT（Auto Transaction）** 模式是基于事务代理的模式，立即执行并保存修改前后快照信息。RM由seata框架管理。`缺弥补了XA模型中资源锁定周期过长的缺陷`。

- AT模式的优点：
  - 一阶段完成直接提交事务，释放数据库资源，性能比较好
  - 利用全局锁实现读写隔离
  - 没有代码侵入（不用自己写代码），框架自动完成回滚和提交

### 2.2两阶段提交

#### 阶段一：事务执行阶段

- **TM（事务管理器）**：
  - 启动全局事务，并管理事务的生命周期。
  - 负责协调并通知 **TC** 和 **RM** 开始事务。
  - 在执行过程中，**TM** 会记录每个操作，确保系统能够在需要时进行回滚或补偿。

- **TC（事务协调者）**：
  - 负责管理和控制全局事务的执行进度。
  - **TC** 会与多个 **RM** 进行交互，确保所有资源管理器按照约定执行事务。
  - **TC** 会等待所有 **RM** 的反馈，确认是否可以提交事务。

- **RM（资源管理器）**：
  - 负责本地事务的执行，执行资源管理的操作（如数据库操作）。
  - **RM** 会记录操作日志，确保如果事务需要回滚时能够通过 **Undo Log** 进行恢复。
  - 资源管理器不向 **TC** 发送 Prepare 消息，而是直接执行操作并准备好相关补偿策略。

#### 阶段二：提交或回滚阶段

- **TM（事务管理器）**：
  - 监控事务的整体进度，协调全局事务的提交或回滚。
  - **TM** 会根据 **TC** 的决策通知相关操作，如是否提交或回滚。

- **TC（事务协调者）**：
  - 根据所有 **RM** 的反馈决定是否提交或回滚全局事务。
  - 如果所有 **RM** 都成功执行，**TC** 会发出提交指令。
  - 如果任一 **RM** 失败或全局事务选择回滚，**TC** 会发出回滚指令。
  - 负责协调全局事务的最终结果，确保系统的一致性。

- **RM（资源管理器）**：
  - 根据 **TC** 的指令执行提交或回滚操作。
  - 提交时，**RM** 会正式确认本地事务的执行结果。
  - 回滚时，**RM** 会使用 **Undo Log** 或补偿操作来撤销本地事务，恢复到事务开始之前的状态。

<Badge text="important" type="important" /> 

#### 总结

1. **执行阶段**：事务开始执行并记录日志，资源管理器执行操作。
2. **提交/回滚阶段**：协调者根据资源管理器的反馈来决定全局事务是否提交或回滚，资源管理器根据指令提交或撤销操作。

### 2.3 简述AT模式与XA模式最大的区别是什么？

- XA模式一阶段不提交事务，锁定资源；AT模式一阶段直接提交，不锁定资源。

- XA模式依赖数据库机制实现回滚；AT模式利用数据快照实现数据回滚。
- XA模式强一致；AT模式最终一致

### 2.4缺点

- 两阶段之间属于软状态，属于最终一致
- 框架的快照功能会影响性能，但比XA模式要好很多

## 3.TCC 模式  
**TCC（Try-Confirm-Cancel）** 是一种分布式事务的补偿性事务模型，它通过将事务分为三个阶段来保证一致性

> 类似银行卡的预授权功能。

### 3.1三个阶段

#### 1. **Try 阶段**

   - **事务发起方（RM）**：
     - 在 Try 阶段，发起方执行业务操作的预留（预占资源）工作，并保证该操作可以被确认或取消。此阶段的核心是资源预留（例如：库存扣减，但不实际减少）。
     - 在 Try 阶段，发起方会向事务协调者（TC）报告预留的操作结果。
   
   - **事务协调方（TC）**：
     - 事务协调方接收来自发起方的 Try 请求，并记录该请求的结果。TC 不做实际的业务操作，只是协调各个发起方的事务状态。
   
   - **事务管理者（TM）**：
     - 事务管理者负责发起整个分布式事务，并向事务协调方发出事务请求。TM 会跟踪事务的生命周期，协调各个参与者的工作。

#### 2. **Confirm 阶段**

   - **事务发起方（RM）**：
     - 在 Confirm 阶段，发起方会正式提交之前预留的操作，通常是实际的业务执行（例如：实际减库存，确认操作）。
     - 确认时，发起方将提交事务并向事务协调方报告确认结果。
   
   - **事务协调方（TC）**：
     - 事务协调方负责判断所有参与者的事务状态。如果所有参与者都报告了成功的 Try 阶段，并且在 Confirm 阶段也成功提交，则事务协调方会最终提交事务。
   
   - **事务管理者（TM）**：
     - 事务管理者协调整个事务的最终状态，在确认阶段，TM 会收到所有参与者的确认请求并最终决定事务是否提交。

#### 3. **Cancel 阶段**

   - **事务发起方（RM）**：
     - 如果在 Try 阶段成功预留了资源，但事务在后续步骤中失败或被要求取消，发起方将执行回滚操作，撤销之前的预留资源。
     - 例如：库存恢复、订单撤销等。
   
   - **事务协调方（TC）**：
     - 事务协调方根据事务的最终状态决定是否触发 Cancel 阶段。如果事务的某个参与者报告失败或不满足条件，TC 会触发 Cancel 阶段来回滚事务。
   
   - **事务管理者（TM）**：
     - 事务管理者会在事务失败时指引进入 Cancel 阶段，确保参与者回滚已做的操作。

#### 总结

- **Try 阶段**：预留资源，确保操作可回滚或确认；
- **Confirm 阶段**：确认资源并提交操作；
- **Cancel 阶段**：回滚操作，撤销所有预留资源。

### 3.2空回滚

某一个RM在一阶段阻塞导致全局事务在二阶段超时触发cancel，此RM未执行完try去执行cancel，此时的cancel没东西做回滚就是空回滚。

### 3.3事务悬挂

一个已经空回滚的事务，阻塞的try突然畅通，但是无法再有下一步操作，导致事务无法正常结束

##  4.SEGA 模式

**SEGA（SAGA）** 是一种分布式事务的模式，采用了一系列本地事务和补偿事务来保证最终一致性。SAGA 模式将一个大事务拆分成多个小的本地事务，每个小事务独立执行。如果某个事务失败，就通过执行补偿事务来回滚前面的操作。  

- **特点**:
  - 每个子事务独立执行，可以在分布式环境下实现高可用性。
  - 通过补偿机制确保最终一致性，适用于长事务。
  - 支持多种实现方式，例如补偿型 SAGA 和基于消息的 SAGA。
- **缺点**:
  - 较复杂的补偿逻辑实现，可能导致业务逻辑不易维护。
  - 需要保证每个子事务和补偿事务的幂等性。

## 总结：

- **XA**：保证强一致性的分布式事务，适用于需要多资源管理器协调的场景，但性能开销较大。
- **AT**：轻量级自动事务管理，简化开发，但不适合复杂事务。
- **TCC**：精细化的三阶段事务模式，通过补偿机制保证一致性，适用于业务逻辑清晰的场景。
- **SAGA**：通过一系列本地事务和补偿事务来保证最终一致性，适用于长事务和高可用场景。

> XA模式下RM准备好了报告TC后，TC批准再干，不让干不干。
>
> AT模式下RM记小本本上直接干，TC说干的不行再看小本本干回去，干的好就保留。
>
> TCC模式下RM先从一堆苹果中护下几个，TC说可以拿了就拿走，不可以拿就放回去。类似银行卡的预授权。
